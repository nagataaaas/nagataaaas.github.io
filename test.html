<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.19.0/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.14.0/css/xterm.css"/>
    <script src="https://cdn.jsdelivr.net/npm/xterm@4.14.0/lib/xterm.min.js"></script>
</head>
<style>
    #terminal {
        display: flex;
        flex-direction: row;
    }
</style>

<body>
<div id="terminal"></div>

<script>

    async function main() {
        let pyodide = await loadPyodide({indexURL: "https://cdn.jsdelivr.net/pyodide/v0.19.0/full/"});

        const Color = {
            red: function (code) {
                return '\033[31m' + code + '\033[39m'
            }
        }

        let commands = []
        let buffer = []
        let leading = '>>> '

        let ms = 100;
        var term = new Terminal({
            fontFamily: '"Cascadia Code", Menlo, monospace',
            cursorBlink: true
        });
        term.open(document.getElementById('terminal'));
        term.writeln(`Interpreter Loading time: ${ms}ms`)
        term.writeln(`Welcome to the Pyodide terminal emulator 🐍 Version ${pyodide.version}`,)
        term.write(leading)

        window.term = term;
        pyodide.runPython(`
          import io, code, sys
          from js import term

          class Console(code.InteractiveConsole):
              def runcode(self, code):
                  sys.stdout = io.StringIO()
                  sys.stderr = io.StringIO()
                  term.runPython("\\n".join(self.buffer))
          _c = Console(locals=globals())
        `)

        var c = pyodide.pyimport('_c')

        function handleResult(result) {
          if (result) {
            term.set_prompt('[[;gray;]... ]')
          } else {
            term.set_prompt('[[;red;]>>> ]')
            var stderr = pyodide.runPython("sys.stderr.getvalue()").trim()
            if (stderr) {
              term.echo(`[[;red;]${stderr}]`)
            } else {
              var stdout = pyodide.runPython("sys.stdout.getvalue()")
              if (stdout) {
                term.echo(stdout.trim())
              }
            }
          }
        }

        term.runPython = function (code) {
            pyodide.runPythonAsync(code).then(
                term.handlePythonResult, term.handlePythonError
            ).finally(()=>{
                term.write(leading)
            })
        }

        term.handlePythonResult = function (result) {
            console.log(result)
            if (result === undefined) {
                leading = '>>> '
            } else if (result['_repr_html_'] !== undefined) {
                term.write(result['_repr_html_'])
            } else {
                const values = result.toString().split('\n')
                buffer = buffer.concat(values)
                for (let line of values) {
                    term.writeln(line)
                }
            }
        }

        term.handlePythonError = function (result) {
            console.log(result)

            const values = result.toString().split('\n').map(v => Color.red(v))
            buffer = buffer.concat(values)
            for (let line of values) {
                term.writeln(line)
            }
            leading = '>>> '
        }

        let command = ''
        term.onData(e => {
            switch (e) {
                case '\u0003': // Ctrl+C
                    term.write('^C');
                    prompt(term);
                    break;
                case '\r': // Enter
                    term.writeln('\n');
                    term.runPython(command)
                    command = ''
                    break
                case '\u007F': // Backspace (DEL)
                    // Do not delete the prompt
                    if (term._core.buffer.x > 4) {
                        term.write('\b \b');
                    }
                    command = command.substr(0, command.length - 1);
                    break
                case '\u001b[A': // Up Arrow
                    term.write('\x1b[D')
                    break
                case '\u001b[B': // Down Arrow
                    term.write('\x1b[D')
                    break
                case '\u001b[C': // Right Arrow
                    term.write('\x1b[C')
                    break
                case '\u001b[D': // Left Arrow
                    term.write('\x1b[D')
                    break
                default: // Print all other characters for demo
                    if (e >= String.fromCharCode(0x20) && e <= String.fromCharCode(0x7B) || e >= '\u00a0') {
                        command += e;
                        term.write(e);
                    }
            }
        })
    };
    main();
</script>
</body>
</html>